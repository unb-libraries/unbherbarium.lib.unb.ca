<?php

/**
 * @file
 * Add style to feature pages.
 */

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_preprocess_views_exposed_form().
 */
function herbarium_specimen_preprocess_views_exposed_form(&$variables) {
  $variables['#attached']['library'][] = 'herbarium_specimen/views-form';
}

/**
 * Implements hook_node_presave().
 */
function herbarium_specimen_node_presave(EntityInterface $node) {
  if ($node->getType() == 'herbarium_specimen') {
    // Determine if this is a new image that needs surrogates generated.
    if ($node->get('field_large_sample_surrogate')->get(0) != NULL) {
      if (
        (
          $node->original == NULL ||
          $node->original->get('field_large_sample_surrogate')->get(0) == NULL
        )
        ||
        (
          $node->original->get('field_large_sample_surrogate')->get(0) != NULL &&
          $node->get('field_large_sample_surrogate')->get(0)->getValue()['target_id'] != $node->original->get('field_large_sample_surrogate')->get(0)->getValue()['target_id']
        )
      ) {

        $batch = array(
          'title' => t('Generating Specimen Surrogate Images'),
          'init_message' => t('Generating Specimen Surrogate Images'),
          'operations' => array(
            array(
              array(
                'Drupal\herbarium_specimen\HerbariumImageTileFactory',
                'buildImageTiles',
              ),
              array($node->get('field_large_sample_surrogate')->get(0)->entity),
            ),
          ),
        );

        batch_set($batch);
      }
    }

  }
}
